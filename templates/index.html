<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PARSEwithMe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0f0f0f, #2a2a2a);
      color: white;
      scroll-behavior: smooth;
    }
    .highlight {
      color: #d8b4fe;
      font-weight: 700;
    }
    h1, h2, h3 {
      color: #c4b5fd;
    }
    .btn {
      background: linear-gradient(90deg, #6366f1, #ec4899);
      color: white;
      padding: 12px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1.1rem;
      transition: all 0.25s ease;
      cursor: pointer;
      user-select: none;
      border: none;
    }
    .btn:hover {
      transform: scale(1.05);
      background: linear-gradient(90deg, #4f46e5, #db2777);
      box-shadow: 0 0 15px rgba(236, 72, 153, 0.5);
    }
    .btn-secondary {
      background: transparent;
      border: 2px solid #6366f1;
      color: white;
    }
    .btn-secondary:hover {
      background: rgba(99, 102, 241, 0.1);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
    }
    header {
      background: #000000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.7);
    }
    nav a {
      color: #e0e7ff;
      font-weight: 600;
      font-size: 1.125rem;
      padding: 6px 12px;
      transition: all 0.3s ease;
      border-radius: 8px;
    }
    nav a:hover {
      color: #ec4899;
      background: rgba(236, 72, 153, 0.1);
      text-decoration: none;
    }
    .logo-text {
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 1.8rem;
      background: linear-gradient(90deg, #ec4899, #6366f1);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 10px rgba(236, 72, 153, 0.3);
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }
    .logo-text:hover {
      text-shadow: 0 0 15px rgba(236, 72, 153, 0.5);
      transform: scale(1.02);
    }
    main {
      padding-top: 100px;
      max-width: 900px;
      margin: 0 auto;
    }
    section {
      margin-bottom: 8rem;
    }
    #home {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }
    #home h2 {
      font-size: 4rem;
      margin-bottom: 2rem;
      line-height: 1.2;
    }
    #home p {
      font-size: 1.5rem;
      line-height: 1.7;
      max-width: 750px;
      margin: 0 auto 3rem auto;
      color: #d1d5db;
    }
    #home ul {
      text-align: left;
      max-width: 600px;
      margin: 0 auto 3rem auto;
      font-size: 1.25rem;
      line-height: 1.8;
    }
    #home ul li {
      margin-bottom: 1rem;
      position: relative;
      padding-left: 2rem;
    }
    #home ul li:before {
      content: "‚Üí";
      position: absolute;
      left: 0;
      color: #ec4899;
    }
    .cta-buttons {
      display: flex;
      gap: 1.5rem;
      justify-content: center;
      margin-top: 3rem;
    }
    
    /* Updated Platforms Section */
    .platforms-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
      width: 100%;
    }
    
    .platforms-row {
      display: flex;
      justify-content: center;
      gap: 2rem;
      width: 100%;
    }
    
    /* First row - 3 cards */
    .platforms-row:first-child {
      justify-content: space-between;
    }
    
    /* Second row - 2 centered cards */
    .platforms-row:last-child {
      justify-content: center;
      gap: 4rem;
    }
    
    .platform-card {
      background: rgba(30, 41, 59, 0.7);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(99, 102, 241, 0.2);
      width: 250px;
    }
    
    .platform-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.2);
      border-color: rgba(99, 102, 241, 0.5);
    }
    .platform-card img {
      width: 60px;
      height: 60px;
      margin: 0 auto 1.5rem auto;
      object-fit: contain;
    }
    .platform-card h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    /* Modal Styling */
    .modal {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: #1e293b;
      padding: 30px;
      border-radius: 16px;
      max-width: 420px;
      box-shadow: 0 0 30px rgba(236, 72, 153, 0.4);
      color: white;
      animation: modalFadeIn 0.3s ease-out;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .auth-tabs {
      display: flex;
      margin-bottom: 25px;
      border-bottom: 1px solid #334155;
    }
    .auth-tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      color: #94a3b8;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    .auth-tab.active {
      color: #ec4899;
      border-bottom: 3px solid #ec4899;
    }
    .auth-tab:hover {
      color: #d8b4fe;
    }
    .auth-form {
      display: none;
    }
    .auth-form.active {
      display: block;
    }
    .form-input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      border: 2px solid #334155;
      margin-bottom: 16px;
      font-size: 1rem;
      color: white;
      background: rgba(15, 23, 42, 0.7);
      transition: all 0.3s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    .form-footer {
      margin-top: 20px;
      font-size: 0.9rem;
      color: #94a3b8;
    }
    .form-footer a {
      color: #d8b4fe;
      text-decoration: none;
      transition: color 0.2s;
    }
    .form-footer a:hover {
      color: #ec4899;
      text-decoration: underline;
    }
    #about {
      text-align: center;
    }
    #about h2 {
      font-size: 2.5rem;
      margin-bottom: 3rem;
      position: relative;
      display: inline-block;
    }
    #about h2:after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: linear-gradient(90deg, #ec4899, #6366f1);
    }
    #about p {
      font-size: 1.25rem;
      line-height: 1.8;
      max-width: 700px;
      margin: 0 auto 2rem auto;
      color: #cbd5e1;
      text-align: left;
    }
    .team-members {
      display: flex;
      justify-content: flex-start;
      gap: 2rem;
      flex-wrap: wrap;
      margin-top: 3rem;
    }
    .team-member {
      background: rgba(30, 41, 59, 0.7);
      border-radius: 16px;
      padding: 1.5rem;
      width: 200px;
      transition: all 0.3s ease;
    }
    .team-member:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.2);
    }
    .team-member h3 {
      color: #d8b4fe;
      margin: 1rem 0 0.5rem 0;
    }
    .team-member p {
      color: #94a3b8;
      font-size: 1rem;
      text-align: center;
      margin: 0;
    }
    /* Loading Spinner */
    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 4px solid #ec4899;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .parse-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
      background: rgba(30, 41, 59, 0.7);
      border-radius: 16px;
      border: 1px solid rgba(99, 102, 241, 0.2);
    }
    .parse-input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      border: 2px solid #334155;
      margin-bottom: 20px;
      font-size: 1rem;
      color: white;
      background: rgba(15, 23, 42, 0.7);
    }
    .parse-input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    .parse-result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.7);
      display: none;
    }
  </style>
</head>
<body>
  <header class="flex justify-between items-center px-8 py-4 fixed top-0 left-0 right-0 z-50">
    <div class="logo-text">PARSEwithME</div>
    <nav class="flex space-x-2">
      <a href="#home">Home</a>
      <a href="#platforms">Platforms</a>
      <a href="#parse">Parse</a>
      <a href="#about">About</a>
      <a onclick="openAuthModal('login')" class="cursor-pointer">Login</a>
    </nav>
  </header>

  <main>
    <section id="home">
      <h2>Welcome to <span class="highlight">PARSEwithMe</span></h2>
      <p>
        The ultimate tool for investigators and forensic analysts to efficiently document and preserve social media evidence with precision and ease.
      </p>
      <ul>
        <li>üßæ Comprehensive PDF documentation ready for court submission</li>
        <li>üîç Platform-specific parsing for maximum accuracy</li>
        <li>üñ•Ô∏è Cross-platform compatibility for flexible workflows</li>
        <li>üîí Secure evidence preservation with metadata integrity</li>
      </ul>
      <div class="cta-buttons">
        <button class="btn" onclick="openAuthModal('signup')">Get Started</button>
        <button class="btn btn-secondary" onclick="document.querySelector('#platforms').scrollIntoView({ behavior: 'smooth' })">Explore Platforms</button>
      </div>
    </section>

    <section id="platforms" class="opacity-0 transition-opacity duration-700 ease-in-out">
      <h2 class="text-center text-3xl mb-12">Supported Platforms</h2>
      <div class="platforms-container">
        <!-- First Row - 3 Cards -->
        <div class="platforms-row">
          <div class="platform-card">
            <img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram" />
            <h3>Instagram</h3>
            <p>Capture profiles, posts, stories and more with metadata preservation</p>
          </div>
          <div class="platform-card">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/2021_Facebook_icon.svg/1024px-2021_Facebook_icon.svg.png" alt="Facebook" />
            <h3>Facebook</h3>
            <p>Document profiles, posts, comments and messages</p>
          </div>
          <div class="platform-card">
            <img src="https://cdn-icons-png.flaticon.com/512/2111/2111646.png" alt="Telegram" />
            <h3>Telegram</h3>
            <p>Capture channels, groups and private conversations</p>
          </div>
        </div>
        
        <!-- Second Row - 2 Centered Cards -->
        <div class="platforms-row">
          <div class="platform-card">
            <img src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png" alt="YouTube" />
            <h3>YouTube</h3>
            <p>Document videos, comments, channels and metadata</p>
          </div>
          <div class="platform-card">
            <img src="https://cdn-icons-png.flaticon.com/512/2111/2111589.png" alt="Reddit" />
            <h3>Reddit</h3>
            <p>Preserve posts, comments, subreddits and user histories</p>
          </div>
        </div>
      </div>
    </section>

    <section id="parse" class="opacity-0 transition-opacity duration-700 ease-in-out">
      <h2 class="text-center text-3xl mb-12">Parse Social Media Content</h2>
      <div class="parse-container">
        <input type="text" id="keywordInput" placeholder="Enter keyword or URL to parse" class="parse-input" />
        <button class="btn w-full" onclick="startParsing()">Start Parsing</button>
        
        <div id="loadingIndicator" class="loading-spinner hidden"></div>
        
        <div id="parseResult" class="parse-result">
          <h3 class="text-xl mb-2">Parsing Complete!</h3>
          <p class="mb-4">Your PDF report is ready to download.</p>
          <a id="downloadPdf" href="#" class="btn w-full" download>Download PDF Report</a>
        </div>
        <div id="pdfBox" class="parse-result" style="display:none;"></div>
      </div>
    </section>

    <section id="about" class="opacity-0 transition-opacity duration-700 ease-in-out">
      <h2>Meet the Team</h2>

      <p>
        We're three passionate computer science students from Dronacharya College of Engineering who came together to build PARSEwithMe as part of our FAER Scholar Program submission. What began as an academic project quickly evolved into a mission to support digital forensic investigations.
      </p>
      
      <p>
        We believe technology should make processes simpler, smarter, and more secure ‚Äî and we hope this tool takes one step in that direction.
      </p>
      <p>
        We believe in making technology work for justice - ensuring digital evidence is captured accurately, completely, and in a format that maintains its integrity throughout the investigative process.
      </p>
      <div class="team-members">
        <div class="team-member">
          <img src="https://ui-avatars.com/api/?name=Priyasha+Sharma&background=6366f1&color=fff&size=100" alt="Priyasha Sharma" class="rounded-full mx-auto">
          <h3>Priyasha Sharma</h3>
        </div>
        <div class="team-member">
          <img src="https://ui-avatars.com/api/?name=Nikita+Pandita&background=ec4899&color=fff&size=100" alt="Nikita Pandita" class="rounded-full mx-auto">
          <h3>Nikita Pandita</h3>
        </div>
        <div class="team-member">
          <img src="https://ui-avatars.com/api/?name=Yash+Yadav&background=8b5cf6&color=fff&size=100" alt="Yash Yadav" class="rounded-full mx-auto">
          <h3>Yash Yadav</h3>
        </div>
      </div>
    </section>
  </main>

  <!-- Auth Modal -->
  <div id="authModal" class="modal fixed inset-0 hidden flex items-center justify-center z-50">
    <div class="modal-content">
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
        <!-- Sign Up tab removed -->
      </div>
      
      <!-- Login Form -->
      <div id="loginForm" class="auth-form active">
        <input type="text" placeholder="Username or Email" class="form-input" />
        <input type="password" placeholder="Password" class="form-input" />
        <button class="btn w-full">Login</button>
        <div class="form-footer">
          <!-- Removed Forgot password and Sign up links -->
        </div>
      </div>
      
      <!-- Signup Form -->
      <div id="signupForm" class="auth-form">
        <input type="text" placeholder="Username" class="form-input" />
        <input type="email" placeholder="Email" class="form-input" />
        <input type="password" placeholder="Password" class="form-input" />
        <input type="password" placeholder="Confirm Password" class="form-input" />
        <button class="btn w-full">Create Account</button>
        <div class="form-footer">
          <span>Already have an account? <a onclick="switchAuthTab('login')" class="cursor-pointer">Login</a></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Smooth fade-in sections on scroll
    const sections = document.querySelectorAll('section:not(#home)');
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.remove('opacity-0');
          entry.target.classList.add('opacity-100');
        }
      });
    }, { threshold: 0.3 });
    sections.forEach(section => observer.observe(section));
    
    // Modal functions
    function openModal(id) {
      document.getElementById(id).classList.remove('hidden');
    }
    
    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }
    
    // Auth modal functions
    function openAuthModal(formType) {
      openModal('authModal');
      switchAuthTab(formType);
    }
    
    function switchAuthTab(formType) {
      // Update tabs
      document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.auth-tab[onclick="switchAuthTab('${formType}')"]`).classList.add('active');
      
      // Update forms
      document.getElementById('loginForm').classList.remove('active');
      document.getElementById('signupForm').classList.remove('active');
      document.getElementById(`${formType}Form`).classList.add('active');
    }
    
    // --- API helpers ---
    async function apiPost(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(data)
      });
      return res.json();
    }
    async function apiGet(url) {
      const res = await fetch(url, { credentials: 'same-origin' });
      return res.json();
    }
    
    // --- Auth logic ---
    let currentUser = null;
    
    // Login
    function handleLogin() {
      const inputs = document.querySelectorAll('#loginForm .form-input');
      const username = inputs[0].value.trim();
      const password = inputs[1].value;
      apiPost('/login', { username, password }).then(res => {
        if (res.success) {
          currentUser = res.username;
          closeModal('authModal');
          updateAuthUI();
          loadPDFs();
          showPDFBox();
        } else {
          alert('Login failed: ' + (res.error || 'Invalid credentials'));
        }
      });
    }
    // Signup
    function handleSignup() {
      const inputs = document.querySelectorAll('#signupForm .form-input');
      const username = inputs[0].value.trim();
      const email = inputs[1].value.trim(); // not used in backend
      const password = inputs[2].value;
      const confirm = inputs[3].value;
      if (password !== confirm) {
        alert('Passwords do not match');
        return;
      }
      apiPost('/signup', { username, password }).then(res => {
        if (res.success) {
          currentUser = res.username;
          closeModal('authModal');
          updateAuthUI();
          loadPDFs();
        } else {
          alert('Signup failed: ' + (res.error || 'Unknown error'));
        }
      });
    }
    // Logout
    function handleLogout() {
      apiPost('/logout', {}).then(() => {
        currentUser = null;
        updateAuthUI();
        clearHistoryUI();
        clearPadsUI();
      });
    }
    
    // --- UI updates for auth ---
    function updateAuthUI() {
      const nav = document.querySelector('nav');
      let userBtn = document.getElementById('userBtn');
      let resetBtn = document.getElementById('resetPwdBtn');
      if (currentUser) {
        if (!userBtn) {
          userBtn = document.createElement('a');
          userBtn.id = 'userBtn';
          userBtn.className = 'cursor-pointer';
          nav.appendChild(userBtn);
        }
        userBtn.textContent = `Logout (${currentUser})`;
        userBtn.onclick = handleLogout;
        if (!resetBtn) {
          resetBtn = document.createElement('a');
          resetBtn.id = 'resetPwdBtn';
          resetBtn.className = 'cursor-pointer';
          resetBtn.textContent = 'Reset Password';
          resetBtn.onclick = showResetPasswordModal;
          nav.appendChild(resetBtn);
        }
        nav.querySelector('a[onclick*="openAuthModal"]').style.display = 'none';
      } else {
        if (userBtn) userBtn.remove();
        if (resetBtn) resetBtn.remove();
        nav.querySelector('a[onclick*="openAuthModal"]').style.display = '';
      }
    }
    
    // --- Password reset ---
    function showResetPasswordModal() {
      let modal = document.getElementById('resetPwdModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'resetPwdModal';
        modal.className = 'modal fixed inset-0 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="mb-4 text-lg font-bold">Reset Password</h3>
            <input type="password" id="resetPwd1" placeholder="New Password" class="form-input" />
            <input type="password" id="resetPwd2" placeholder="Confirm Password" class="form-input" />
            <button class="btn w-full" onclick="handleResetPassword()">Reset</button>
            <button class="btn btn-secondary w-full mt-2" onclick="closeModal('resetPwdModal')">Cancel</button>
          </div>`;
        document.body.appendChild(modal);
      }
      openModal('resetPwdModal');
    }
    function handleResetPassword() {
      const p1 = document.getElementById('resetPwd1').value;
      const p2 = document.getElementById('resetPwd2').value;
      if (p1 !== p2 || !p1) {
        alert('Passwords do not match');
        return;
      }
      apiPost('/reset_password', { password: p1 }).then(res => {
        if (res.success) {
          alert('Password reset successful!');
          closeModal('resetPwdModal');
        } else {
          alert('Failed to reset password');
        }
      });
    }
    
    // --- PDF helpers ---
    function savePDF() {
      fetch('/report', { method: 'POST', credentials: 'same-origin' })
        .then(res => res.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'parsewithme_report.pdf';
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        });
    }
    
    // --- Parse functionality (search) ---
    function startParsing() {
      if (!currentUser) {
        openAuthModal('login');
        return;
      }
      const keyword = document.getElementById('keywordInput').value.trim();
      if (!keyword) {
        alert('Please enter a keyword or URL to parse');
        return;
      }
      // Save search to history with username before parsing
      saveSearchToHistory(keyword, currentUser);
      document.getElementById('loadingIndicator').classList.remove('hidden');
      document.getElementById('parseResult').style.display = 'none';
      apiPost('/extract', { keyword, num_results: 5 }).then(res => {
        document.getElementById('loadingIndicator').classList.add('hidden');
        showParseResults(res);
        loadHistory();
        loadPDFs();
      }).catch((err) => {
        document.getElementById('loadingIndicator').classList.add('hidden');
        openAuthModal('login');
      });
    }

    function saveSearchToHistory(keyword, username) {
      // Save to backend for persistent history
      const now = new Date();
      const timestamp = now.toLocaleString();
      apiPost('/history', { keyword, timestamp }).then(() => {
        loadHistory(); // Refresh history after saving
      });
    }
    
    // --- Shuffle Results ---
let lastResults = null;
function shuffleResults() {
  if (!lastResults) return;
  // Shuffle each platform's results
  const shuffled = {};
  for (const key of Object.keys(lastResults)) {
    if (Array.isArray(lastResults[key])) {
      shuffled[key] = [...lastResults[key]].sort(() => Math.random() - 0.5);
    } else {
      shuffled[key] = lastResults[key];
    }
  }
  showParseResults(shuffled, true);
}

function showParseResults(res, isShuffle) {
  lastResults = res;
  const resultDiv = document.getElementById('parseResult');
  let html = `<h3 class="text-xl mb-4 font-bold text-center">Parsing Complete!${isShuffle ? ' (Shuffled)' : ''}</h3>`;
  html += '<div class="w-full max-w-5xl mx-auto bg-slate-900/80 rounded-2xl shadow-2xl p-8 flex flex-wrap gap-6 justify-center items-stretch">';

  function platformCard(title, icon, color, items, renderFn) {
    if (!items || !items.length) return '';
    return `
      <div class="flex-1 min-w-[320px] max-w-[420px] flex flex-col justify-between rounded-xl shadow-lg p-5 bg-gradient-to-br from-${color}-900 to-${color}-700 border border-${color}-400/30">
        <div class="flex items-center mb-3">
          <img src="${icon}" class="w-8 h-8 mr-2" alt="${title} icon"/>
          <span class="font-semibold text-lg text-${color}-200">${title}</span>
        </div>
        <ul class="space-y-2 text-sm">${items.map(renderFn).join('')}</ul>
      </div>
    `;
  }

  html += platformCard(
    'Reddit',
    'https://cdn-icons-png.flaticon.com/512/2111/2111589.png',
    'orange',
    res.reddit_posts,
    p => `<li class="bg-orange-800/30 rounded p-2"><b>${p.title || ''}</b><br>${p.text || ''}<br><a href="${p.url || ''}" target="_blank" class="underline text-orange-200">${p.url ? 'View Post' : ''}</a></li>`
  );
  html += platformCard(
    'Telegram',
    'https://cdn-icons-png.flaticon.com/512/2111/2111646.png',
    'blue',
    // Always show the Telegram section, even if empty
    (res.telegram_messages && res.telegram_messages.length > 0)
      ? res.telegram_messages
      : [{chat: '', text: '<i>No Telegram results found</i>', date: ''}],
    m => `<li class="bg-blue-800/30 rounded p-2">
      <b>${m.chat || ''}</b><br>${m.text || ''}${m.date ? `<br><span class='text-xs text-gray-400'>${m.date}</span>` : ''}
    </li>`
  );
  html += platformCard(
    'YouTube',
    'https://cdn-icons-png.flaticon.com/512/1384/1384060.png',
    'red',
    res.youtube_videos,
    v => `<li class="bg-red-800/30 rounded p-2"><b>${v.title}</b><br><a href="${v.url}" target="_blank" class="underline text-red-200">Watch</a> <span class="ml-2 text-xs text-red-100">${v.channel || ''}</span></li>`
  );
  html += platformCard(
    'Instagram',
    'https://cdn-icons-png.flaticon.com/512/2111/2111463.png',
    'purple',
    res.instagram_posts,
    p => `<li class="bg-purple-800/30 rounded p-2 flex flex-col gap-1">
      <span class="font-semibold text-purple-200">
        ${p.username ? `<a href='https://instagram.com/${p.username}' target='_blank' class='underline text-purple-200'>@${p.username}</a>` : ''}
      </span>
      <span>${p.caption || ''}</span>
      ${p.image_url ? `<img src='${p.image_url}' class='rounded mt-2 max-h-40 object-cover border border-purple-400/30' alt='Instagram post'/>` : ''}
      ${p.url ? `<a href='${p.url}' target='_blank' class='underline text-purple-200'>View Post</a>` : ''}
    </li>`
  );
  html += platformCard(
    'Facebook',
    'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/2021_Facebook_icon.svg/1024px-2021_Facebook_icon.svg.png',
    'indigo',
    res.facebook_videos,
    v => `<li class="bg-indigo-800/30 rounded p-2 flex flex-col gap-1">
      <span class="font-semibold text-indigo-200">
        ${v.username ? `<a href='https://facebook.com/${v.username}' target='_blank' class='underline text-indigo-200'>${v.username}</a>` : ''}
      </span>
      <span>${v.title || ''}</span>
      ${v.url ? `<a href='${v.url}' target='_blank' class='underline text-indigo-200'>View Post</a>` : ''}
    </li>`
  );

  html += '</div>';
  html += '<div class="flex gap-4 mt-6"><button class="btn flex-1" onclick="savePDFButton()">Save PDF</button><button class="btn btn-secondary flex-1" onclick="shuffleResults()">Shuffle Results</button></div>';
  resultDiv.innerHTML = html;
  resultDiv.style.display = 'block';
}
    
    // --- Save pad ---
    function savePad() {
      const pad = document.getElementById('parseResult').innerHTML;
      apiPost('/save', { pad }).then(res => {
        if (res.success) {
          alert('Pad saved!');
          loadPads();
        } else {
          alert('Failed to save pad');
        }
      });
    }
    
    // --- History ---
    function loadHistory() {
      apiGet('/history').then(res => {
        showHistory(res.history || []);
        // showHistoryBox(); // removed
      });
    }
    function showHistory(history) {
      let histDiv = document.getElementById('historyDiv');
      if (!histDiv) {
        histDiv = document.createElement('div');
        histDiv.id = 'historyDiv';
        histDiv.className = 'parse-result';
        document.querySelector('#parse').appendChild(histDiv);
      }
      let clearBtn = `<button class="btn btn-secondary mb-2" onclick="clearHistory()">Clear History</button>`;
      histDiv.innerHTML = '<h3>Search History</h3>' + clearBtn + (history.length ? '<ul>' + history.map(h => `<li>${h}</li>`).join('') + '</ul>' : '<i>No history</i>');
      histDiv.style.display = 'block';
    }
    function clearHistory() {
      apiPost('/history/clear', {}).then(() => {
        loadHistory();
      });
    }
    function clearHistoryUI() {
      const histDiv = document.getElementById('historyDiv');
      if (histDiv) histDiv.style.display = 'none';
    }
    
    // --- Pads ---
    function loadPads() {}
    function showPads() {}
    function clearPadsUI() {
      const padDiv = document.getElementById('padsDiv');
      if (padDiv) padDiv.remove();
    }
    
    // --- PDF (was pad) ---
    function savePDFButton() {
      savePDF();
    }
    function loadPDFs() {
      apiGet('/pdfs').then(res => {
        showPDFs(res.pdfs || []);
        showPDFBox();
      });
    }
    function showPDFs(pdfs) {
      let pdfDiv = document.getElementById('pdfsDiv');
      if (!pdfDiv) {
        pdfDiv = document.createElement('div');
        pdfDiv.id = 'pdfsDiv';
        pdfDiv.className = 'parse-result';
        document.querySelector('#parse').appendChild(pdfDiv);
      }
      pdfDiv.innerHTML = '<h3>Saved PDFs</h3>' + (pdfs.length ? '<ul>' + pdfs.map((p, i) => `<li>PDF ${i+1}: <a href="/pdfs/${encodeURIComponent(p)}" target="_blank" class="underline">Download</a></li>`).join('') + '</ul>' : '<i>No PDFs saved</i>');
      pdfDiv.style.display = 'block';
    }
    function clearPDFsUI() {
      const pdfDiv = document.getElementById('pdfsDiv');
      if (pdfDiv) pdfDiv.style.display = 'none';
    }
    
    // --- Attach event handlers ---
    document.querySelector('#loginForm .btn').onclick = handleLogin;
    document.querySelector('#signupForm .btn').onclick = handleSignup;
    
    // On load, check if logged in (try to load history/pads)
    window.addEventListener('DOMContentLoaded', () => {
      updateAuthUI();
      // Hide history and PDF boxes until login
      const pdfBox = document.getElementById('pdfBox');
      if (pdfBox) pdfBox.style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
      if (event.target.classList.contains('modal')) {
        closeModal('authModal');
      }
    });
    
    function showHistoryBox() {
  apiGet('/history').then(res => {
    const box = document.getElementById('historyBox');
    if (!box) return;
    box.innerHTML = '<h3 class="font-bold mb-2">Search History</h3>' +
      (res.history && res.history.length ? '<ul>' + res.history.map(h => {
        // Try to extract keyword, timestamp, and username from the history string
        let match = h.match(/^(.*?)\s+‚Äî\s+(.*?)\s+‚Äî\s+(.*)$/);
        let keyword = h, timestamp = '', username = '';
        if (match) {
          keyword = match[1];
          timestamp = match[2];
          username = match[3];
        }
        return `<li><span class='font-semibold'>${keyword}</span> <span class='text-xs text-gray-400'>${timestamp}</span> <span class='text-xs text-green-400 ml-2'>@${username}</span> <a href="#" class="underline text-blue-300 ml-2" title="Go to result" onclick="startParsingFromHistory('${keyword.replace(/'/g, '\'')}')">üîé</a></li>`;
      }).join('') + '</ul>' : '<div>No history yet.</div>');
    box.style.display = 'block';
  });
}
  </script>
</body>
</html>
